---
title: Online Unsafe Recover 使用文档
summary: 如何使用 Online Unsafe Recover
---

# Online Unsafe Recover (experimental) 使用文档

> **警告**
>
> 此命令一般用于解决多数副本永久损坏造成的部分数据不可用的问题，为有损恢复，此命令的运行无法保证数据完整性！
> 建议在 TiDB 团队支持下进行相关操作，操作不当可能导致集群难以恢复。

> **警告**
>
> 此功能仍处于测试阶段，其接口，策略和内部实现在最终发布时可能会有所变化。此功能已通过一部分普通常见场景的测试，但还未经过广泛验证，不排除存在系统在使用此命令进行恢复后仍不可用的可能性。

本文介绍 Online Unsafe Recover 的使用场景，使用方法和注意事项等。

TiDB 是一个具备高可用性的数据库，根据用户定义的副本规则不同，一份数据在 TiDB 中可能同时存储于多个结点，以保证在单个或少数结点暂时离线或者损坏时，数据的读写不受任何影响。但是。为了保证数据的完整性，短时间内多数或全部副本的下线则会让此段数据变得暂时不可用。当部分数据因多数结点下线而不可用时，我们建议重启失败结点，假如多数的数据文件没有损坏，此段数据在部分结点重启后会恢复可用。如果一段数据多数副本发生了永久性损坏（如磁盘损坏）或其他原因导致无法上线时，此段数据则会一直保持其不可用状态。如果使用者想让集群可以恢复正常使用，并且对于数据回退或者丢失是可以容忍的，那么，我们理论上可以通过手动覆写数据分片元信息的方式来使其重新可以形成多数派，进而让上层业务可以继续写入，或者读取（可能是 stale 的，或者为空）这一段的数据分片。当无法恢复的结点数量较多，进而导致受影响的数据分片过多时，手动逐个修改每个数据分片的元信息会变得既枯燥又不可靠。为了简xx这一系列运维操作，我们设计了 Onlne Unsafe Recover 让用户可以尽量简单，快速地对于可容忍数据丢失的数据库,在部分结点永久性损坏时，进行有损恢复。

相较于逐个修改分片元信息， Online Unsafe Recover 在经 `pdctl` 触发后，会发送请求至PD，在此之后所有的操作将会由PD继续完成。PD在接受请求后，会收集全部结点内的数据分片元信息，并借由此全局视角来生成一份更实时，完整的恢复计划。恢复计划在生成后，会由PD下发给各存活结点去执行。当各结点再次上报的信息和PD所期待的状态相匹配时，整个流程结束。

## 使用场景

Online Unsafe Recover 的一般使用场景为:

* 有部分结点永久损坏，无法重启，并造成了业务端部分数据不可读，不可写。
* 数据丢失可以容忍，而希望受影响的数据行可以恢复读写。
* 希望可以在线，一站恢复。

## 使用方法

1. Pre-check
    * 部分数据确实不可用。
    * 离线结点确实无法自动恢复（重启）。
2. 暂时关闭load balancing等内部调度（建议在关闭后等待几个小时，使已经触发的调度有充分时间完成）。
    * 在pdctl中使用`config show`获取当前配置信息
    * 在pdctl中使用`config set region-schedule-limit 0`
    * 在pdctl中使用`config set replica-schedule-limit 0`
    * 在pdctl中使用`config set merge-schedule-limit 0`
3. 使用pdctl中`unsafe remove-failed-stores <store_id>[,<store_id>,...]`命令移除无法自动恢复的结点，注意，此命令返回的成功仅代表请求被接受，实际恢复过程会在后台进行。
4. 在上述命令运行成功之后，通过`unsafe remove-failed-stores show (or history)`来查看进度。
5. 当进度命令提示完成之后，可以使用常规数据访问方式确保数据可以读写。注意，数据可以读写并不代表没有数据丢失。
6. 重新开启调度,将之前修改过配置调整回初始设置。