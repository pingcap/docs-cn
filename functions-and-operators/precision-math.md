---
title: 精确数学
summary: 了解 TiDB 中的精确数学。
---

# 精确数学

TiDB 中的精确数学支持与 MySQL 一致。更多信息，请参见 [MySQL 中的精确数学](https://dev.mysql.com/doc/refman/8.0/en/precision-math.html)。

## 数值类型

精确数学的作用范围包括精确值数据类型（整数和 DECIMAL 类型）和精确值数字字面量。近似值数据类型和数字字面量作为浮点数处理。

精确值数字字面量具有整数部分或小数部分，或两者都有。它们可以带符号。示例：`1`、`.2`、`3.4`、`-5`、`-6.78`、`+9.10`。

近似值数字字面量以科学计数法（10的幂）表示，包含尾数和指数。任一部分或两部分都可以带符号。示例：`1.2E3`、`1.2E-3`、`-1.2E3`、`-1.2E-3`。

看起来相似的两个数字可能会被不同对待。例如，`2.34` 是精确值（定点）数字，而 `2.34E0` 是近似值（浮点）数字。

DECIMAL 数据类型是定点类型，计算是精确的。FLOAT 和 DOUBLE 数据类型是浮点类型，计算是近似的。

## DECIMAL 数据类型特征

本节讨论 DECIMAL 数据类型（及其同义词）的以下特征：

- 最大位数
- 存储格式
- 存储要求

DECIMAL 列的声明语法是 `DECIMAL(M,D)`。参数的取值范围如下：

- M 是最大位数（精度）。1 <= M <= 65。
- D 是小数点右边的位数（标度）。1 <= D <= 30，且 D 不能大于 M。

M 的最大值为 65 意味着 DECIMAL 值的计算精确到 65 位。这个 65 位精度的限制也适用于精确值数字字面量。

DECIMAL 列的值使用二进制格式存储，将 9 个十进制数字打包到 4 个字节中。每个值的整数部分和小数部分的存储要求是分别确定的。每 9 位数字需要 4 个字节，剩余的数字需要 4 个字节的一部分。剩余数字所需的存储空间由下表给出。

| 剩余位数 | 字节数 |
| --- | --- |
| 0   | 0 |
| 1–2 | 1 |
| 3–4 | 2 |
| 5–6 | 3 |
| 7–9 | 4 |

例如，`DECIMAL(18,9)` 列在小数点两边各有 9 位数字，因此整数部分和小数部分各需要 4 个字节。`DECIMAL(20,6)` 列有 14 位整数和 6 位小数。整数位需要 4 个字节存储其中的 9 位数字，剩余的 5 位需要 3 个字节。6 位小数需要 3 个字节。

DECIMAL 列不存储前导 `+` 字符或 `-` 字符或前导 `0` 数字。如果您将 `+0003.1` 插入到 `DECIMAL(5,1)` 列中，它将被存储为 `3.1`。对于负数，不存储字面的 `-` 字符。

DECIMAL 列不允许超出列定义所暗示范围的值。例如，`DECIMAL(3,0)` 列支持 `-999` 到 `999` 的范围。`DECIMAL(M,D)` 列在小数点左边最多允许 `M - D` 位数字。

有关 DECIMAL 值内部格式的更多信息，请参见 TiDB 源代码中的 [`mydecimal.go`](https://github.com/pingcap/tidb/blob/release-8.1/pkg/types/mydecimal.go)。

## 表达式处理

对于精确数学的表达式，TiDB 尽可能使用给定的精确值数字。例如，比较中的数字按原样使用，不改变值。在严格 SQL 模式下，如果您将精确数据类型添加到列中，如果数字在列范围内，则按其精确值插入。检索时，值与插入的值相同。如果未启用严格 SQL 模式，TiDB 允许 INSERT 时进行截断。

如何处理数值表达式取决于表达式的值：

- 如果表达式包含任何近似值，结果是近似的。TiDB 使用浮点运算评估表达式。
- 如果表达式不包含近似值，即仅包含精确值，且如果任何精确值包含小数部分，则使用 DECIMAL 精确运算评估表达式，精度为 65 位。
- 否则，表达式仅包含整数值。表达式是精确的。TiDB 使用整数运算评估表达式，精度与 BIGINT（64 位）相同。

如果数值表达式包含字符串，字符串将转换为双精度浮点值，表达式的结果是近似的。

插入数值列受 SQL 模式影响。以下讨论提到严格模式和 `ERROR_FOR_DIVISION_BY_ZERO`。要启用所有限制，您可以简单地使用 `TRADITIONAL` 模式，它包括严格模式值和 `ERROR_FOR_DIVISION_BY_ZERO`：

```sql
SET sql_mode = 'TRADITIONAL`;
```

如果将数字插入精确类型列（DECIMAL 或整数），如果它在列范围内，则按其精确值插入。对于这个数字：

- 如果小数部分的位数过多，会进行舍入并生成警告。
- 如果整数部分的位数过多，数值太大，处理如下：
    - 如果未启用严格模式，值会截断为最接近的合法值并生成警告。
    - 如果启用严格模式，会发生溢出错误。

要将字符串插入数值列，如果字符串包含非数字内容，TiDB 按如下方式处理从字符串到数字的转换：

- 在严格模式下，不以数字开头的字符串（包括空字符串）不能用作数字。会发生错误或警告。
- 以数字开头的字符串可以转换，但会截断尾部的非数字部分。在严格模式下，如果截断的部分包含除空格以外的任何内容，会发生错误或警告。

默认情况下，除以 0 的结果为 NULL，且不会有警告。通过适当设置 SQL 模式，可以限制除以 0。如果启用 `ERROR_FOR_DIVISION_BY_ZERO` SQL 模式，TiDB 对除以 0 的处理不同：

- 在严格模式下，禁止插入和更新，并发生错误。
- 如果不在严格模式下，会发生警告。

在以下 SQL 语句中：

```sql
INSERT INTO t SET i = 1/0;
```

在不同的 SQL 模式下返回以下结果：

| `sql_mode` 值 | 结果 |
| :--- | :--- |
| '' | 无警告，无错误；i 设置为 NULL。|
| strict | 无警告，无错误；i 设置为 NULL。 |
| `ERROR_FOR_DIVISION_BY_ZERO` | 有警告，无错误；i 设置为 NULL。 |
| strict, `ERROR_FOR_DIVISION_BY_ZERO` | 错误；不插入行。 |

## 舍入行为

`ROUND()` 函数的结果取决于其参数是精确值还是近似值：

- 对于精确值数字，`ROUND()` 函数使用"四舍五入"规则。
- 对于近似值数字，TiDB 中的结果与 MySQL 中的不同：

    ```sql
    TiDB > SELECT ROUND(2.5), ROUND(25E-1);
    +------------+--------------+
    | ROUND(2.5) | ROUND(25E-1) |
    +------------+--------------+
    |          3 |            3 |
    +------------+--------------+
    1 row in set (0.00 sec)
    ```

对于插入到 DECIMAL 或整数列中的值，舍入使用[远离零舍入](https://en.wikipedia.org/wiki/Rounding#Round_half_away_from_zero)。

```sql
TiDB > CREATE TABLE t (d DECIMAL(10,0));
Query OK, 0 rows affected (0.01 sec)

TiDB > INSERT INTO t VALUES(2.5),(2.5E0);
Query OK, 2 rows affected, 2 warnings (0.00 sec)

TiDB > SELECT d FROM t;
+------+
| d    |
+------+
|    3 |
|    3 |
+------+
2 rows in set (0.00 sec)
```
