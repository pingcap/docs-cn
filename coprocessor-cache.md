---
title: Coprocessor 缓存
summary: 了解 Coprocessor 缓存的功能特性。
---

# Coprocessor 缓存

从 v4.0 开始，TiDB 实例支持缓存下推到 TiKV 的计算结果（Coprocessor 缓存功能），这可以在某些场景下加速计算过程。

## 配置

<CustomContent platform="tidb">

您可以通过 TiDB 配置文件中的 `tikv-client.copr-cache` 配置项配置 Coprocessor 缓存。有关如何启用和配置 Coprocessor 缓存的详细信息，请参见 [TiDB 配置文件](/tidb-configuration-file.md#tikv-clientcopr-cache-new-in-v400)。

</CustomContent>

<CustomContent platform="tidb-cloud">

Coprocessor 缓存功能默认启用。可以缓存的数据的最大大小为 1000 MB。

</CustomContent>

## 功能说明

+ 当 SQL 语句第一次在单个 TiDB 实例上执行时，执行结果不会被缓存。
+ 计算结果缓存在 TiDB 的内存中。如果 TiDB 实例重启，缓存将失效。
+ 缓存不在 TiDB 实例之间共享。
+ 只缓存下推计算结果。即使命中缓存，TiDB 仍然需要执行后续计算。
+ 缓存以 Region 为单位。向 Region 写入数据会导致该 Region 的缓存失效。因此，Coprocessor 缓存功能主要对很少变化的数据有效。
+ 当下推计算请求相同时，缓存会命中。通常在以下场景中，下推计算请求相同或部分相同：
    - SQL 语句相同。例如，重复执行相同的 SQL 语句。

        在这种场景下，所有下推计算请求都一致，所有请求都可以使用下推计算缓存。

    - SQL 语句包含一个变化的条件，其他部分一致。变化的条件是表的主键或分区。

        在这种场景下，一些下推计算请求与之前的某些请求相同，这些计算请求可以使用缓存的（之前的）下推计算结果。

    - SQL 语句包含多个变化的条件，其他部分一致。变化的条件恰好匹配复合索引列。

        在这种场景下，一些下推计算请求与之前的某些请求相同，这些计算请求可以使用缓存的（之前的）下推计算结果。

+ 此功能对用户透明。启用或禁用此功能不会影响计算结果，只会影响 SQL 执行时间。

## 检查缓存效果

您可以通过执行 `EXPLAIN ANALYZE` 或查看 Grafana 监控面板来检查 Coprocessor 的缓存效果。

### 使用 `EXPLAIN ANALYZE`

您可以使用 [`EXPLAIN ANALYZE` 语句](/sql-statements/sql-statement-explain-analyze.md)在[访问表的算子](/choose-index.md#访问表的算子)中查看缓存命中率。请看以下示例：

```sql
EXPLAIN ANALYZE SELECT * FROM t USE INDEX(a);
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| id                            | estRows   | actRows | task      | access object          | execution info                                                                                                                                                                                                                                           | operator info                  | memory                | disk |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| IndexLookUp_6                 | 262400.00 | 262400  | root      |                        | time:620.513742ms, loops:258, cop_task: {num: 4, max: 5.530817ms, min: 1.51829ms, avg: 2.70883ms, p95: 5.530817ms, max_proc_keys: 2480, p95_proc_keys: 2480, tot_proc: 1ms, tot_wait: 1ms, rpc_num: 4, rpc_time: 10.816328ms, copr_cache_hit_rate: 0.75} |                                | 6.685169219970703 MB  | N/A  |
| ├─IndexFullScan_4(Build)      | 262400.00 | 262400  | cop[tikv] | table:t, index:a(a, c) | proc max:93ms, min:1ms, p80:93ms, p95:93ms, iters:275, tasks:4                                                                                                                                                                                           | keep order:false, stats:pseudo | 1.7549400329589844 MB | N/A  |
| └─TableRowIDScan_5(Probe)     | 262400.00 | 0       | cop[tikv] | table:t                | time:0ns, loops:0                                                                                                                                                                                                                                        | keep order:false, stats:pseudo | N/A                   | N/A  |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
3 rows in set (0.62 sec)
```

执行结果的 `execution info` 列给出了 `copr_cache_hit_ratio` 信息，表示 Coprocessor 缓存的命中率。上述示例中的 `0.75` 表示命中率约为 75%。

### 查看 Grafana 监控面板

在 Grafana 中，您可以在 `tidb` 命名空间下的 `distsql` 子系统中看到 **copr-cache** 面板。此面板监控整个集群中 Coprocessor 缓存的命中次数、未命中次数和缓存丢弃次数。
