---
title: DEADLOCKS
summary: 了解 information_schema 表 `DEADLOCKS`。
---

# DEADLOCKS

`DEADLOCKS` 表提供了当前 TiDB 节点最近发生的若干次死锁错误的信息。

> **警告：**
>
> 该功能目前为实验性功能，表结构的定义和行为将来可能有较大改动。

{{< copyable "sql" >}}

```sql
USE information_schema;
DESC deadlocks;
```

```
+--------------------+---------------------+------+------+---------+-------+ 
| Field              | Type                | Null | Key  | Default | Extra | 
+--------------------+---------------------+------+------+---------+-------+ 
| DEADLOCK_ID        | bigint(21)          | NO   |      | NULL    |       | 
| OCCUR_TIME         | timestamp(6)        | YES  |      | NULL    |       | 
| RETRYABLE          | tinyint(1)          | NO   |      | NULL    |       | 
| TRY_LOCK_TRX_ID    | bigint(21) unsigned | NO   |      | NULL    |       | 
| CURRENT_SQL_DIGEST | varchar(64)         | YES  |      | NULL    |       | 
| KEY                | text                | YES  |      | NULL    |       | 
| TRX_HOLDING_LOCK   | bigint(21) unsigned | NO   |      | NULL    |       | 
+--------------------+---------------------+------+------+---------+-------+ 
```

`DEADLOCKS` 表中需要用多行来表示同一个死锁事件，每行显示参与死锁的其中一个事务的信息。当该 TiDB 节点记录了多次死锁错误时，需要按照 `DEADLOCK_ID` 列来区分，相同的 `DEADLOCK_ID` 表示同一个死锁事件。需要注意，`DEADLOCK_ID` **并不保证全局唯一，也不会持久化**，因而其只能在同一个结果集里表示同一个死锁事件。

`DEADLOCKS` 表的各列的含义如下：

* `DEADLOCK_ID`：死锁事件的 ID。当表内存在多次死锁错误的信息时，需要使用该列来区分属于不同死锁错误的行。
* `OCCUR_TIME`：发生该次死锁错误的时间。
* `RETRYABLE`：该次死锁错误是否可重试。目前暂不支持收集可充式的死锁错误的信息，因而该字段恒为 0。在一些特定的情况下，一个死锁错误可能是可重试的，此时 TiDB 内部会自动重试。
* `TRY_LOCK_TRX_ID`：试图上锁的事务 ID，即事务的 start ts。
* `CURRENT_SQL_DIGEST`：试图上锁的事务当前正在执行的 SQL 语句的 Digest。
* `KEY`：该事务试图上锁、但是被阻塞的 key，以十六进制编码的形式显示。
* `TRX_HOLDING_LOCK`：该 key 上当前持锁并导致阻塞的事务的事务 ID，即事务的 start ts。

`DEADLOCKS` 表中可以容纳的死锁事件的个数可以由配置文件的 [`pessimistic-txn.deadlock-history-capacity`](/tidb-configuration-file#deadlock-history-capacity) 配置项来调整，默认会容纳最近 10 次死锁错误的信息。

## 示例 1

假设有如下表定义和初始数据：

{{< copyable "sql" >}}

```sql
create table t (id int primary key, v int);
insert into t values (1, 10), (2, 20);
```

令两个事务按如下顺序执行：

| 事务 1                               | 事务 2                               | 说明                 |
|--------------------------------------|--------------------------------------|----------------------|
| `update t set v = 11 where id = 1;`  |                                      |                      |
|                                      | `update t set v = 21 where id = 2;`  |                      |
| `update t set v = 12 where id = 2;`  |                                      | 事务 1 阻塞          |
|                                      | `update t set v = 22 where id = 1;`  | 事务 2 报出死锁错误  |

接下来，事务 2 将报出死锁错误。此时，查询 `DEADLOCKS` 表，将得到如下结果：

{{< copyable "sql" >}}

```sql
select * from information_schema.deadlocks;
```

```
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+----------------------------------------+--------------------+
| DEADLOCK_ID | OCCUR_TIME                 | RETRYABLE | TRY_LOCK_TRX_ID    | CURRENT_SQL_DIGEST                                               | KEY                                    | TRX_HOLDING_LOCK   |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+----------------------------------------+--------------------+
|           1 | 2021-06-04 08:22:38.765699 |         0 | 425405959304904707 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | 7480000000000000385F728000000000000002 | 425405959304904708 |
|           1 | 2021-06-04 08:22:38.765699 |         0 | 425405959304904708 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | 7480000000000000385F728000000000000001 | 425405959304904707 |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+----------------------------------------+--------------------+
```

该表中产生了两行数据，两行的 `DEADLOCK_ID` 字段皆为 1，表示这两行数据包含同一次死锁错误的信息。第一行显示事务 ID 为 `425405959304904707` 的事务，在 `"7480000000000000385F728000000000000002"` 这个 key 上，被事务 ID 为 `"425405959304904708"` 的事务阻塞了；第二行则显示事务 ID 为 `"425405959304904708"` 的事务在 `"7480000000000000385F728000000000000001"` 这个 key 上被事务 ID 为 `425405959304904707` 的事务阻塞了，构成了相互阻塞的状态，形成了死锁。

## 示例 2

假设查询 `DEADLOCKS` 表获得了如下结果集：

```
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+----------------------------------------+--------------------+
| DEADLOCK_ID | OCCUR_TIME                 | RETRYABLE | TRY_LOCK_TRX_ID    | CURRENT_SQL_DIGEST                                               | KEY                                    | TRX_HOLDING_LOCK   |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+----------------------------------------+--------------------+
|           1 | 2021-06-04 08:22:38.765699 |         0 | 425405959304904707 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | 7480000000000000385F728000000000000002 | 425405959304904708 |
|           1 | 2021-06-04 08:22:38.765699 |         0 | 425405959304904708 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | 7480000000000000385F728000000000000001 | 425405959304904707 |
|           2 | 2021-06-04 08:22:56.795410 |         0 | 425405961664462853 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | 7480000000000000385F728000000000000002 | 425405961664462854 |
|           2 | 2021-06-04 08:22:56.795410 |         0 | 425405961664462854 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | 7480000000000000385F728000000000000003 | 425405961664462855 |
|           2 | 2021-06-04 08:22:56.795410 |         0 | 425405961664462855 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | 7480000000000000385F728000000000000001 | 425405961664462853 |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+----------------------------------------+--------------------+
```

上述结果中的 `DEADLOCK_ID` 表明，前两行共同表示一次死锁错误的信息，两条事务相互等待构成了死锁；而后三行共同表示另一次死锁信息，三个事务循环等待构成了死锁。

## CLUSTER_DEADLOCKS

`CLUSTER_DEADLOCKS` 表是 `DEADLOCKS` 的集群版本，其返回整个集群上的每个 TiDB 节点中最近发生数次的死锁错误（每个节点上的 `DEADLOCKS` 表内的信息合并到一起）。`CLUSTER_DEADLOCKS` 包含额外的 `INSTANCE` 列展示所属节点的 IP 地址和端口，用以区分不同的 TiDB 节点。

需要注意的是，由于 `DEADLOCK_ID` 并不保证全局唯一，所以在 `CLUSTER_DEADLOCKS` 表的查询结果中，需要 `INSTANCE` 和 `DEADLOCK_ID` 两个字段共同区分结果集中的不同死锁错误的信息。

{{< copyable "sql" >}}

```sql
USE information_schema;
DESC cluster_deadlocks;
```

```
+--------------------+---------------------+------+------+---------+-------+
| Field              | Type                | Null | Key  | Default | Extra |
+--------------------+---------------------+------+------+---------+-------+
| INSTANCE           | varchar(64)         | YES  |      | NULL    |       |
| DEADLOCK_ID        | bigint(21)          | NO   |      | NULL    |       |
| OCCUR_TIME         | timestamp(6)        | YES  |      | NULL    |       |
| RETRYABLE          | tinyint(1)          | NO   |      | NULL    |       |
| TRY_LOCK_TRX_ID    | bigint(21) unsigned | NO   |      | NULL    |       |
| CURRENT_SQL_DIGEST | varchar(64)         | YES  |      | NULL    |       |
| KEY                | text                | YES  |      | NULL    |       |
| TRX_HOLDING_LOCK   | bigint(21) unsigned | NO   |      | NULL    |       |
+--------------------+---------------------+------+------+---------+-------+
```

## SQL Digest

`DEADLOCKS` 表中会记录 SQL Digest，并不记录 SQL 原文。

SQL Digest 是 SQL 归一化之后的哈希值。对于最近一段时间内执行过的语句，可以从 `STATEMENTS_SUMMARY` 或 `STATEMENTS_SUMMARY_HISTORY` 中根据 Digest 查找到对应的归一化 SQL 的原文：

{{< copyable "sql" >}}

```sql
select digest, digest_text from information_schema.statements_summary where digest = "f7530877a35ae65300c42250abd8bc731bbaf0a7cabc05dab843565230611bb2";
```

```
+------------------------------------------------------------------+---------------------------------------+
| digest                                                           | digest_text                           |
+------------------------------------------------------------------+---------------------------------------+
| f7530877a35ae65300c42250abd8bc731bbaf0a7cabc05dab843565230611bb2 | update `t` set `v` = ? where `id` = ? |
+------------------------------------------------------------------+---------------------------------------+
```

关于 SQL Digest 和 `STATEMENTS_SUMMARY`、`STATEMENTS_SUMMARY_HISTORY` 表的详细说明请参阅 [Statement Summary Tables](/statement-summary-tables)。

