---
title: SQL 优化案例
summary: 了解 TiDB 中常见的 SQL 优化方法
---

# 复合索引策略

## 等于条件和 order by key 的优先级

1. 以下分页查询的执行时间为 12.2 秒，从数据库获取 10 行，执行效率低下。
2. 如果阅读执行计划：
   1. 阅读执行计划，通过indexLoopKUp 算子访问数据，IndexFullScan_20 算子对主键索引 ENCODEDKEY 进行索引全扫描，确保扫描数据有序 `keep order:true`, 因为需要对整个索引全部进行扫描，返回了 662258 行，花费了12.2秒
   2. 接着通过└─TableRowIDScan_21 和 └─Selection_22 进行回表和 `accountstate` 字段上的过滤, └─Selection_22 算子返回 11999 行。通过主键索引扫描之后还需要回表，说明该表不是 clustered index。如果使用 clustered index，则可避免回表操作。
   3. 后续通过 └─Projection_24 算子之后数据下降为 4096 行，└─Projection_24 之后下降为 2048 行，
   4. 通过 limits 算子，下降为 10 行


{{< copyable "sql" >}}
```sql
SELECT
  `encodedkey`
FROM
  `savingsaccount`
WHERE
  `accountstate` IN ('ACTIVE', 'APPROVED')
ORDER BY
  `encodedkey`
LIMIT
    10;
```

{{< copyable "sql" >}}

```sql
id                         	task     	estRows	operator info                                                                         	actRows	execution info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              	memory   	disk
Projection_7               	root     	10     	bankingbaseline.savingsaccount.encodedkey                                             	10     	time:12.2s, loops:2, Concurrency:OFF                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        	804 Bytes	N/A
└─Limit_13                 	root     	10     	offset:1230, count:10                                                                 	10     	time:12.2s, loops:2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         	N/A      	N/A
  └─Projection_24          	root     	1240   	bankingbaseline.savingsaccount.encodedkey, bankingbaseline.savingsaccount.accountstate	2048   	time:12.2s, loops:2, Concurrency:5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          	191.7 KB 	N/A
    └─IndexLookUp_23       	root     	1240   	                                                                                      	4096   	time:12.2s, loops:4, index_task: {total_time: 12.2s, fetch_handle: 12.2s, build: 11ms, wait: 67.5µs}, table_task: {total_time: 68.4ms, num: 8, concurrency: 5}                                                                                                                                                                                                                                                                                                                                                             	18.7 MB  	N/A
      ├─IndexFullScan_20   	cop[tikv]	1251.65	table:savingsaccount, index:PRIMARY(ENCODEDKEY), keep order:true                      	662258 	time:12.2s, loops:112, cop_task: {num: 1, max: 12.2s, proc_keys: 662258, tot_proc: 12.2s, tot_wait: 16ms, rpc_num: 1, rpc_time: 12.2s, copr_cache_hit_ratio: 0.00}, tikv_task:{time:492ms, loops:651}, scan_detail: {total_process_keys: 662258, total_process_keys_size: 86755798, total_keys: 668559, rocksdb: {delete_skipped_count: 0, key_skipped_count: 667658, block: {cache_hit_count: 1276, read_count: 0, read_byte: 0 Bytes}}}                                                                                   	N/A      	N/A
      └─Selection_22       	cop[tikv]	1240   	in(bankingbaseline.savingsaccount.accountstate, "ACTIVE", "APPROVED")                 	11999  	time:50.7ms, loops:22, cop_task: {num: 8, max: 13.4ms, min: 2.37ms, avg: 6.03ms, p95: 13.4ms, max_proc_keys: 4096, p95_proc_keys: 4096, tot_proc: 40ms, rpc_num: 8, rpc_time: 48.1ms, copr_cache_hit_ratio: 0.00}, tikv_task:{proc max:12ms, min:0s, p80:8ms, p95:12ms, iters:40, tasks:8}, scan_detail: {total_process_keys: 11999, total_process_keys_size: 12418965, total_keys: 18307, rocksdb: {delete_skipped_count: 16, key_skipped_count: 35685, block: {cache_hit_count: 1776, read_count: 0, read_byte: 0 Bytes}}}	N/A      	N/A
        └─TableRowIDScan_21	cop[tikv]	1251.65	table:savingsaccount, keep order:false                                                	11999  	tikv_task:{proc max:12ms, min:0s, p80:8ms, p95:12ms, iters:40, tasks:8}                                                                                                                                                                                                                                                                                                                                                                                                                                                     	N/A      	N/A
```

3. 优化思路
   1. 现有表结构只存在 ENCODEDKEY 字段，针对该 SQL，可以新建覆盖索引 (accountstate, ENCODEDKEY), 前导列为 accountstate 可以避免访问无效数据，第二列 ENCODEDKEY 可以避免排序操作，只需要分别扫描 accountstate 为 `ACTIVE` 和 `APPROVED` 两种状态的前 10 条记录。
{{< copyable "sql" >}}
```sql
alter table bankingbaseline.savingsaccount add index (accountstate, ENCODEDKEY);
   ```

4. 优化效果
   
{{< copyable "sql" >}}
```sql
```

## 等于条件，非等于条件和 order by key 的优先级问题

{{< copyable "sql" >}}
```sql
SELECT
  *
FROM
  `pancake_tokens`
WHERE
  `address` = ?
  AND `block_number` <= ?
  AND (
    `next_block_number` > ?
    OR `next_block_number` = ?
  )
ORDER BY
  `block_number` DESC
LIMIT
  ?
```

{{< copyable "sql" >}}
```sql
id                               task             estRows          operator info                                                                                                                                                                                                                                                                                                        actRows        execution info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              memory         disk
TopN_9                           root             1                pancake.pancake_tokens.block_number:desc, offset:0, count:1                                                                                                                                                                                                                                                          1              time:15.4s, loops:2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         8.07 KB        N/A
└─IndexLookUp_17                 root             1                                                                                                                                                                                                                                                                                                                                     1              time:15.4s, loops:2, index_task: {total_time: 2.4ms, fetch_handle: 2.39ms, build: 561ns, wait: 5.16µs}, table_task: {total_time: 730µs, num: 1, concurrency: 5}                                                                                                                                                                                                                                                                                                                                                                                                                                           8.46 KB        N/A
  ├─TopN_16                      cop[tikv]        1                pancake.pancake_tokens.block_number:desc, offset:0, count:1                                                                                                                                                                                                                                                          1              time:15.4s, loops:2, cop_task: {num: 3, max: 7.82s, min: 687.8µs, avg: 2.61s, p95: 7.82s, max_proc_keys: 487980, p95_proc_keys: 487980, tot_proc: 7.78s, tot_wait: 39ms, rpc_num: 4, rpc_time: 15.4s, copr_cache_hit_ratio: 0.33}, ResolveLock:{num_rpc:1, total_time:547.1µs}, tikv_task:{proc max:388ms, min:1ms, p80:388ms, p95:388ms, iters:481, tasks:3}, scan_detail: {total_process_keys: 490747, total_process_keys_size: 44657977, total_keys: 491033, rocksdb: {delete_skipped_count: 261, key_skipped_count: 491292, block: {cache_hit_count: 511, read_count: 0, read_byte: 0 Bytes}}}        N/A            N/A
  │ └─Selection_15               cop[tikv]        249129.73        le(pancake.pancake_tokens.block_number, 21760000)                                                                                                                                                                                                                                                                    1              tikv_task:{proc max:386ms, min:1ms, p80:386ms, p95:386ms, iters:481, tasks:3}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               N/A            N/A
  │   └─IndexRangeScan_13        cop[tikv]        251749.23        table:pancake_tokens, index:idx_address(address, next_block_number, block_number), range:[0xBB4CDB9CBD36B01BD1CBAEBF2DE08D9173BC095C 0,0xBB4CDB9CBD36B01BD1CBAEBF2DE08D9173BC095C 0], (0xBB4CDB9CBD36B01BD1CBAEBF2DE08D9173BC095C 21760000,0xBB4CDB9CBD36B01BD1CBAEBF2DE08D9173BC095C +inf], keep order:false        490750         tikv_task:{proc max:366ms, min:1ms, p80:366ms, p95:366ms, iters:481, tasks:3}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               N/A            N/A
  └─TableRowIDScan_14            cop[tikv]        1                table:pancake_tokens, keep order:false                                                                                                                                                                                                                                                                               1              time:660.5µs, loops:2, cop_task: {num: 1, max: 615.3µs, proc_keys: 1, rpc_num: 1, rpc_time: 593.3µs, copr_cache_hit_ratio: 0.00}, tikv_task:{time:0s, loops:1}, scan_detail: {total_process_keys: 1, total_process_keys_size: 492, total_keys: 1, rocksdb: {delete_skipped_count: 0, key_skipped_count: 0, block: {cache_hit_count: 14, read_count: 0, read_byte: 0 Bytes}}}                                                                                                                                                                                                                             N/A            N/A
```

{{< copyable "sql" >}}
```sql
id                                 task             estRows        operator info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                actRows        execution info                                                                                                                                                                                                                                                                                                                                                                                           memory         disk
Limit_12                           root             1              offset:0, count:1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            1              time:3.56ms, loops:2                                                                                                                                                                                                                                                                                                                                                                                     N/A            N/A
└─Projection_30                    root             1              pancake.pancake_tokens.block_number, pancake.pancake_tokens.next_block_number, pancake.pancake_tokens.address, pancake.pancake_tokens.name, pancake.pancake_tokens.symbol, pancake.pancake_tokens.decimals, pancake.pancake_tokens.trade_volume, pancake.pancake_tokens.trade_volume_usd, pancake.pancake_tokens.untracked_volume_usd, pancake.pancake_tokens.total_transactions, pancake.pancake_tokens.total_liquidity, pancake.pancake_tokens.derived_bnb, pancake.pancake_tokens.derived_usd, pancake.pancake_tokens.block_hash, pancake.pancake_tokens.timestamp        1              time:3.56ms, loops:1, Concurrency:OFF                                                                                                                                                                                                                                                                                                                                                                    8.44 KB        N/A
  └─IndexLookUp_29                 root             1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1              time:3.55ms, loops:1, index_task: {total_time: 2.31ms, fetch_handle: 2.31ms, build: 1.14µs, wait: 789ns}, table_task: {total_time: 1.15ms, num: 1, concurrency: 5}                                                                                                                                                                                                                                      8.52 KB        N/A
    ├─Limit_28                     cop[tikv]        1              offset:0, count:1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            1              time:3.53ms, loops:2, cop_task: {num: 1, max: 2.27ms, proc_keys: 32, tot_proc: 2ms, rpc_num: 1, rpc_time: 2.26ms, copr_cache_hit_ratio: 0.00}, tikv_task:{time:2ms, loops:1}, scan_detail: {total_process_keys: 32, total_process_keys_size: 2912, total_keys: 95, rocksdb: {delete_skipped_count: 186, key_skipped_count: 467, block: {cache_hit_count: 12, read_count: 0, read_byte: 0 Bytes}}}        N/A            N/A
    │ └─Selection_27               cop[tikv]        1              or(gt(pancake.pancake_tokens.next_block_number, 22309209), eq(pancake.pancake_tokens.next_block_number, 0))                                                                                                                                                                                                                                                                                                                                                                                                                                                                  1              tikv_task:{time:2ms, loops:1}                                                                                                                                                                                                                                                                                                                                                                            N/A            N/A
    │   └─IndexRangeScan_25        cop[tikv]        5249.00        table:pancake_tokens, index:idx_address_block_next(address, block_number, next_block_number), range:[0xBB4CDB9CBD36B01BD1CBAEBF2DE08D9173BC095C -inf,0xBB4CDB9CBD36B01BD1CBAEBF2DE08D9173BC095C 22309209], keep order:true, desc                                                                                                                                                                                                                                                                                                                                             32             tikv_task:{time:1ms, loops:1}                                                                                                                                                                                                                                                                                                                                                                            N/A            N/A
    └─TableRowIDScan_26            cop[tikv]        1              table:pancake_tokens, keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1              time:1.11ms, loops:2, cop_task: {num: 1, max: 1.07ms, proc_keys: 1, rpc_num: 1, rpc_time: 1.06ms, copr_cache_hit_ratio: 0.00}, tikv_task:{time:0s, loops:1}, scan_detail: {total_process_keys: 1, total_process_keys_size: 491, total_keys: 1, rocksdb: {delete_skipped_count: 0, key_skipped_count: 0, block: {cache_hit_count: 6, read_count: 0, read_byte: 0 Bytes}}}                                 N/A            N/A
    
```

# 如果识别类型转化问题
## 数据类型不一致导致索引无法使用
## 表之前的字符集不一致导致笛卡尔积 join
