---
title: GC 概述
summary: 了解 TiDB 中的垃圾回收机制。
---

# GC 概述

TiDB 使用 MVCC 来控制事务并发。当你更新数据时，原始数据不会立即删除，而是与新数据一起保留，并使用时间戳来区分版本。垃圾回收（GC）的目标是清理过时的数据。

## GC 过程

每个 TiDB 集群都包含一个被选为 GC leader 的 TiDB 实例，它负责控制 GC 过程。

GC 在 TiDB 上周期性运行。对于每次 GC，TiDB 首先计算一个称为"安全点"的时间戳。然后，TiDB 在确保安全点之后的所有快照都保持数据完整性的前提下清理过时的数据。具体来说，每个 GC 过程包含以下三个步骤：

1. 解决锁（Resolve Locks）。在此步骤中，TiDB 扫描所有 Region 上安全点之前的锁，并清理这些锁。
2. 删除范围（Delete Ranges）。在此步骤中，快速清理由 `DROP TABLE`/`DROP INDEX` 操作产生的整个范围的过时数据。
3. 执行 GC（Do GC）。在此步骤中，每个 TiKV 节点扫描其上的数据，并删除每个 key 不需要的旧版本。

在默认配置中，GC 每 10 分钟触发一次。每次 GC 保留最近 10 分钟的数据，这意味着 GC 生命周期默认为 10 分钟（安全点 = 当前时间 - GC 生命周期）。如果一轮 GC 运行时间过长，在这轮 GC 完成之前，即使到了触发下一轮 GC 的时间，下一轮 GC 也不会开始。此外，为了让超过 GC 生命周期的长时间事务能够正常运行，安全点不会超过正在进行的事务的开始时间（start_ts）。

## 实现细节

### 解决锁

TiDB 事务模型是基于 [Google 的 Percolator](https://ai.google/research/pubs/pub36726) 实现的。它主要是一个两阶段提交协议，并进行了一些实践优化。当第一阶段完成时，所有相关的 key 都被锁定。在这些锁中，一个是主锁（primary lock），其他是包含指向主锁指针的次级锁（secondary locks）；在第二阶段，带有主锁的 key 获得一个写记录，并移除其锁。写记录表示该 key 在历史中的写入或删除操作，或者该 key 的事务回滚记录。替换主锁的写记录类型表明相应的事务是否成功提交。然后所有次级锁被依次替换。如果由于故障等原因，这些次级锁被保留而未被替换，你仍然可以根据次级锁中的信息找到主键，并根据主键是否提交来确定整个事务是否提交。但是，如果主键信息被 GC 清理，而该事务有未提交的次级锁，你将永远无法知道这些锁是否可以提交。因此，无法保证数据完整性。

解决锁步骤清理安全点之前的锁。这意味着如果锁的主键已提交，则需要提交该锁；否则，需要回滚。如果主键仍然被锁定（未提交或回滚），则该事务被视为超时并回滚。

解决锁步骤可以通过以下两种方式之一实现，可以使用系统变量 [`tidb_gc_scan_lock_mode`](/system-variables.md#tidb_gc_scan_lock_mode-new-in-v50) 进行配置：

> **警告：**
>
> 目前，`PHYSICAL`（Green GC）是一个实验性功能。不建议在生产环境中使用。

- `LEGACY`（默认）：GC leader 向所有 Region 发送请求以扫描过时的锁，检查扫描到的锁的主键状态，并发送请求以提交或回滚相应的事务。
- `PHYSICAL`：TiDB 绕过 Raft 层，直接在每个 TiKV 节点上扫描数据。

### 删除范围

在 `DROP TABLE/INDEX` 等操作期间，会删除大量具有连续键的数据。删除每个 key 并在之后对它们执行 GC 会导致存储回收的执行效率低下。在这种情况下，TiDB 实际上不会删除每个 key。相反，它只记录要删除的范围和删除的时间戳。然后删除范围步骤对时间戳在安全点之前的范围执行快速物理删除。

### 执行 GC

执行 GC 步骤清理所有 key 的过时版本。为了保证安全点之后的所有时间戳都有一致的快照，此步骤删除安全点之前提交的数据，但保留安全点之前每个 key 的最后一次写入（只要它不是删除操作）。

在此步骤中，TiDB 只需要将安全点发送到 PD，然后整轮 GC 就完成了。TiKV 自动检测安全点的变化，并对当前节点上的所有 Region leader 执行 GC。同时，GC leader 可以继续触发下一轮 GC。

> **注意：**
>
> 从 TiDB 5.0 开始，执行 GC 步骤将始终使用 `DISTRIBUTED` gc 模式。这取代了早期由 TiDB 服务器向每个 Region 发送 GC 请求实现的 `CENTRAL` gc 模式。
