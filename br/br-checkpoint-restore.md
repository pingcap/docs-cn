---
title: 断点恢复
summary: 了解断点恢复功能，包括它的使用场景、使用方法以及实现原理。
---

# 断点恢复

快照恢复/日志恢复会因为一些可恢复性错误导致提前结束，例如硬盘空间占满、节点宕机等等一些突发情况。在 TiDB v7.1.0 之前，在错误被处理之后，之前恢复的进度会作废，你需要重新进行恢复。对大规模集群来说，会造成大量额外成本。

为了尽可能继续上一次的恢复，从 TiDB v7.1.0 起，备份恢复特性引入了断点恢复的功能，恢复在意外退出后可以保留上一次恢复的大部分进度。

## 使用场景

如果你的 TiDB 集群规模很大，无法接受恢复失败后需要重新恢复的情况，那么，你可以使用断点恢复功能重试恢复。br 工具会定期记录已恢复的分片，使得在下一次重试恢复时回到离上一次退出时较近的进度。

## 使用限制

断点恢复功能依赖于 GC 机制，且无法记录所有已恢复的数据，具体描述如下。

### GC 停止

在日志恢复过程中，日志数据恢复的顺序是无序的，因此会存在 delete-kv 优先于 write-kv 恢复的情况。如果此时发起 gc，会将 delete-kv 删除，那么后面恢复的 write-kv 就无法被 gc。所以，br 命令行工具会在日志恢复过程中暂停 gc。当 br 工具中途退出后，gc 将仍然处于暂停状态。

> **注意：**
>
> 日志恢复完成后会重新启动 gc，不需要手动启动。
> 但如果你不想再继续恢复时，请手动开启 gc。
> 暂停 gc 的原理是执行 SQL `set config tikv ``gc.ratio-threshold``=-1.0`
> 手动执行相似的 SQL，例如重置为默认值，则执行 SQL `set config tikv ``gc.ratio-threshold``=1.1`
### 部分数据需要重新恢复

在重试恢复时，部分已恢复的数据可能需要重新恢复，包括正在恢复的数据和还未被断点记录的数据。

- 由错误引起的退出，br 工具会在退出前将已恢复的数据元信息持久化到外部存储中，因此只有正在恢复的数据需要在下一次重试中重新恢复。

- 如果 br 工具进程被系统中断，那么 br 将无法把已恢复的数据元信息持久化到外部存储中。br 工具持久化已恢复的数据元信息的周期为 30 秒，因此大约最近 30 秒内的已完成恢复的数据无法持久化到外部存储，在下次重试时需要重新恢复。

### 不要在恢复期间对集群做数据修改

当 br 日志恢复失败后，请不要对集群写入数据或删除创建表。由于日志备份数据中可能存在重命名表的 ddl 操作，因此断点恢复无法确认被删除的表或已存在的表是否为外部操作所为，从而影响到下一次重试恢复的正确性。
当 br 快照恢复失败后，用户可以对表进行删除操作，但并不建议。

## 实现原理

实现原理分为快照恢复和日志恢复。

### 快照恢复
与快照备份类似，br 工具会批量恢复一段键范围内的所有的 SST 文件，当恢复完成后，br 工具记录下这段范围，并记录下该范围对应的恢复集群的表 id。断点恢复功能会定期将这些新增的相关恢复信息上传至外部存储中，从而持久化存储该恢复任务已完成的区间范围。

在重试恢复时，br 工具会从外部存储读取已经恢复的键范围，并匹配相关的表 id。在恢复时会跳过与断点恢复中记录的键范围重叠且相对应的表 id 匹配的范围。

如果重试恢复前，用户删除了某些表，那么重试恢复时新创建的表的 id 将会与之前记录在断点恢复的表 id 不同，从而绕开使用之前的断点恢复信息，重头恢复该表。

因为数据采用了 mvcc 机制，带有固定 ts 的数据可以被无序且重复写入。

快照恢复在恢复库表信息的时候，添加了 `ifExists` 参数，对于已经存在的库表（视作已经恢复完毕）会自动跳过恢复。

### 日志恢复
日志恢复需要按照时间顺序恢复 meta-kv，断点恢复首先会根据这些 meta-kv 数据创建备份集群和恢复集群一一对应的 id 映射信息，使得在不同重试恢复过程中保证重写 meta-kv 的 id 相同。在这种情况下，meta-kv 就支持了重新恢复的能力。

日志备份文件与快照备份文件不同，日志备份文件的范围会相交叠，因此无法通过键范围来作为恢复进度的元信息，同时还需要假定日志备份文件数量非常多。但每一个日志备份文件在日志备份元信息中的位置是固定的，也就是说，我们可以通过为每个日志备份文件指定一个在日志备份元信息的唯一位置来作为恢复进度的元信息。

日志备份元信息记录着一个存放文件元信息的数组，数组中的一个文件元信息所代表的文件是由许多日志备份文件拼接而成，文件元信息也记录着这些日志备份文件在其中的偏移和大小。所以我们可以用三元组 (日志备份元信息名，文件元信息数组偏移，日志备份文件数组偏移) 来唯一表示一个日志备份文件。
