---
title: BR 新特性简介
summary: 了解 BR 的一些新增特性。
aliases: ['/docs-cn/dev/br/br-features/']
---

# BR 新特性简介

## 自动调节（自 v5.4.0 引入）

### 背景

在 v5.4.0 之前，BR 默认情况下使用的线程数量是总逻辑 CPU 数量的 75%——这是一个非常夸张的值；在没有限速的前提下，BR 会消耗大量的集群资源，对在线集群的性能造成相当大的影响。

即便这些影响可以通过调节线程池的大小完成，观察负载、手动调节线程池大小并不是让人愉悦的事情（相比之下，计算限速似乎更加轻松愉快一些:)）。

为了减少 BR 对在线集群的影响，在 v5.4.0 之后，BR 引入了“自动调节”功能。

### 原理及使用

V5.4.0 之后，TiKV 上将会新增一个配置项：`backup.enable-auto-tune`。

该配置项描述为：**在设置为 “true” 时，在集群资源占用率较高的情况下，自动限制备份使用的资源以求减少对集群的影响。**

自动调节的理念是：通过调节 backup 的线程池大小，保证集群的 CPU 总体使用率不超过某个特定的值。

> 这个特性还有两个并未在 TiKV 文档中列出的配置项，仅仅用做内部调试使用。
>
> 这里为了更好的解释原理，对这两个配置项做一个简单的解释，使用时**无需**配置这两个参数。
> 
> - `backup.auto-tune-remain-threads` 表示，自动调节会通过控制 backup 的资源占用保证集群至少有 `auto-tune-remain-threads` 个核心保持空闲状态。这个参数的默认值是 `round(0.2 * vCPU)`。
> - `backup.auto-tune-refresh-interval` 表示，每隔多长时间，会刷新统计信息并重新计算出备份核心数量上限。

以下是一个示例，其中 * 代表被备份任务占用的 CPU，^ 代表被集群中的其它任务占用的 CPU，- 代表空闲 CPU。

```
|--------| 系统总共有 8 颗逻辑 CPU。
|****----| 默认配置 `backup.num-threads` 为 4，注意在任何时候自动调节都不会让线程池大小大于 backup.num-threads。
|^^****--| 默认情况下，`auto-tune-remain-threads` = round(8 * 0.2) = 2, 自动调节会将 backup 的线程池大小调节至 4。
|^^^^**--| 集群的工作负载加重了，自动调节将备份的线程池大小调节至 2。
```

在监控面板的 “Backup CPU Utilization” 中，可以看到自动限流目前选择的线程池的大小：

![Grafana dashboard example of backup auto-tune metrics](/media/br/backup-auto-throttle.png)

背景中黄色半透明的填充即为自动限流生效后 Backup 可用的线程。

### 局限性

自动调节是一个粗粒度的限流方案：它的优势在无需调节，但是也有不够精确的缺点。

目前已知的问题包括：

1. 如果集群以写负载为主，即便经过限流，备份仍旧可能会影响工作负载。在这种情况下，有较低可能会让工作负载和备份进入一种“正反馈循环”：备份让工作负载使用的资源变少了，而后自动调节误以为资源使用下降了，同时让 backup 更加激进——使得自动调节实际上失效。*如果遇到这种情况，可以手动限制 `backup.num-threads` 的大小。*
2. 如果集群存在热点，热点 TiKV 可能会被过度限流，从而拉慢备份整体的进度。*如果遇到这种情况，可以想办法消除热点节点。或者（如果不在意集群性能降低）在热点节点上关闭自动调节。*
3. 因为自动调节每隔 `auto-tune-refresh-interval`（默认为一分钟） 才会计算出新的限流，所以可能无法很好地对付流量抖动非常厉害的场景。*如果遇到这种情况，可以关闭自动调节。*

自动调节支持使用 `tikv-ctl modify-tikv-config -n backup.enable-auto-tune -v <true|false>` 动态启动/停止，无需重启集群。
