---
title: 使用 PD 微服务提高服务质量
summary: 介绍如何开启 PD 微服务模式提高服务质量
---

# 使用 PD 微服务模式

从 v8.0.0 开始，PD 支持微服务模式。该模式可自定义将 PD 自身拆解成多个组件进行部署，具体包括

- TSO 微服务：为整个集群提供单调递增的时间戳分配
- Scheduling 微服务：为整个集群提供调度功能，包括但不限于负载均衡，热点，副本修复，副本放置等

每种微服务都以独立进程的方式部署，若指定的副本数量大于 1 时，提供主备的容灾模式。

## 使用场景

PD 微服务可以通过将重要模块，如 TSO 分配，调度等模块，与 PD 自身的路由功能进行解耦，让 PD 专注于元数据的路由服务。利用该特性：

- 可以避免 PD 集群压力过大而导致 TSO 分配的长尾或者抖动现象
- 可以避免因为调度模块故障导致整个集群服务不可用的问题
- 可以延缓 PD 自身单点瓶颈的问题

此外，调度模块的变更可以单独更新 Scheduling 微服务，不需要再对 PD 进行重启，进而不会影响集群的整体服务。

## 使用限制

1. TSO 微服务目前不支持动态启停，开启或关闭需要重启 PD 集群。
2. 只有 TiDB 通过服务发现直接连接 TSO 微服务，其他的组件是通过请求转发的方式，将请求通过 PD 转发到 TSO 微服务获取时间戳。

## 相关参数

微服务模式引入了如下命令行子命令：

```
pd-server services <mode>
```

`mode` 支持三种选项，具体如下：

- `api`：若开启微服务，PD 自身将默认以 api mode 启动。启动后不再提供原本 TSO 分配的功能，需要在集群中同时部署 TSO 微服务。另外，原本的调度功能则根据是否部署 scheduling 微服务动态提供。
- `tso`：若 mode 为 tso，即开启 TSO 微服务，提供时间戳分配的功能，需要 PD 以 api mode 启动。
- `scheduling`：若 mode 为 scheduling，即开启 Scheduling 微服务，提供调度功能，需要 PD 以 api mode 启动。开启后，PD 自身将不在提供调度功能。

> **注意：**
>
> 无论是开启 TSO 还是 Scheduling 微服务，PD 都必须以 api mode 启动。
> api mode 和 tso mode 相互依赖，需要集群中同时启用或停用。

上述各种模式通常无需手动设置，由部署工具自动完成。

此外，由于调度微服务是通过服务发现动态开启的，所以如果调度微服务发生宕机后，默认 PD 会继续提供调度的服务。但考虑到允许调度微服务和 PD 使用不同的版本，不同版本的调度逻辑可能会发生变化。所以也提供了开关，在这种情况下，禁止 PD 提供调度服务，防止调度逻辑出现跳变。可以通过设置 `pd-ctl config set enable-scheduling-fallback false` 进行关闭。该参数默认为 true。

## 使用方法

目前仅支持通过 tidb-operator 进行部署。

## 工具兼容性

微服务不影响数据导入导出以及其他同步工具的正常使用。

## 常见问题

1. 是不是所有的集群都适合通过微服务的模式部署？

   不是。微服务主要解决的是 PD 出现瓶颈后导致服务质量下降的问题。如果瓶颈本身不在 PD，则无需开启，微服务本身会增加组件数量，提高运维成本。

## 另请参阅

TODO
