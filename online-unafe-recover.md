---
title: Online Unsafe Recover 使用文档
summary: 如何使用 Online Unsafe Recover
---

# Online Unsafe Recover (experimental) 使用文档

> **注意**
>
> 由于多数副本甚至所有副本已经丢失，运行此命令无法保证数据完整性！
> 建议在 TiDB 团队支持下进行相关操作，操作不当可能导致集群难以恢复
> **注意**
>
> 此功能仍处于测试阶段，其接口，策略和内部实现在最终发布时可能会有所变化。此功能已通过一部分普通常见场景的测试，但还未经过广泛验证，不排除存在系统在使用此命令进行恢复后仍不可用的可能性。

## 功能介绍

TiDB是一个具备高可用性的数据库，根据用户定义的副本规则不同，一份数据在TiDB中可能同时存储于多个结点，以保证在单个或少数结点暂时离线或者损坏时，数据的读写不受任何影响。但是。为了保证数据的完整性，短时间内多数或全部副本的下线则会让此段数据变得暂时不可用。当部分数据因多数结点下线而不可用时，我们建议重启失败结点，假如多数的数据文件没有损坏，此段数据在部分结点重启后会恢复可用。如果一段数据多数副本发生了永久性损坏（如磁盘损坏）或其他原因导致无法上线时，此段数据则会一直保持其不可用状态。如果使用者想让集群可以恢复正常使用，并且对于数据回退或者丢失是可以容忍的，那么，他们可以使用Online Unsafe Recover功能，此功能将在尽可能保留最新，最多数据的前提下，对系统进行**有损恢复**。

## 实现原理

在Online Unsafe Recover被触发后，PD会下发状态报告的命令给所有存活的TiKV结点，而各TiKV结点在受到此命令后，会扫描自身存储的所有数据分片，并将它们的元信息送至PD。PD在受到所有结点的报告后，会开始生成恢复计划：对于没有副本在损坏结点的，或少数副本在损坏结点的正常数据分片，PD将不对其进行任何操作。对于其他丢失了多数副本数据，PD将会依据报告，在所有结点中找寻可以全部覆盖或部分覆盖此段数据的key range，并选择其中最新的来保留。对于全部副本丢失，并且没有stale数据可用的段落，PD将会进行重建，此步骤仅为让用户可以重新写入此部分的数据。在计划计算完成后，PD将会下发它们至各TiKV结点令其执行。之后，PD会持续检查每个TiKV的报告，假如其报告和期待状态不一致，PD将会持续发送恢复计划给此TiKV实例，直到其执行完成。在所有结点均完成计划执行后，恢复结束。

## 流程

0. Pre-check
    * 部分数据确实不可用。
    * 离线结点确实无法自动恢复（重启）。
1. 暂时关闭load balancing等内部调度（建议在关闭后等待几个小时，使已经触发的调度有充分时间完成）。
    * 在pdctl中使用`config show`获取当前配置信息
    * 在pdctl中使用`config set region-schedule-limit 0`
    * 在pdctl中使用`config set replica-schedule-limit 0`
    * 在pdctl中使用`config set merge-schedule-limit 0`
2. 使用pdctl中`unsafe remove-failed-stores <store_id>[,<store_id>,...]`命令移除无法自动恢复的结点，注意，此命令返回的成功仅代表请求被接受，实际恢复过程会在后台进行。
3. 在上述命令运行成功之后，通过`unsafe remove-failed-stores show (or history)`来查看进度。
4. 当进度命令提示完成之后，可以使用常规数据访问方式确保数据可以读写。注意，数据可以读写并不代表没有数据丢失。
5. 重新开启调度,将之前修改过配置调整回初始设置。