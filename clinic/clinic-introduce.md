---
title: Clinic 诊断服务简介
summary: 详细介绍 Clinic 诊断服务，包括工具组件、工作原理和使用场景。
---

## Clinic 诊断服务简介
Clinic 是 PingCAP 对 TiDB 集群提供的诊断服务，包括集群侧工具和云服务，用于从全生命周期确保 TiDB 集群稳定运行、预测并降低问题出现概率、快速定位并修复问题。该工具支持对[使用 TiUP 部署的集群](clinic/clinic-data-instruction-for-tiup.md)和[使用 TiDB Operator 部署的集群](clinic/clinic-user-guide-for-operator.md)进行数据采集和快速检查。

> **注意：**
>
> Clinic 的集群侧工具 Diag 暂时**不支持**对开启了 TLS 加密的集群和使用 TiDB Ansible 部署的集群进行数据采样。

Clinic 诊断服务包括 2 个组件：

- Diag：部署在客户集群侧的工具。该工具支持诊断数据采集 (collect) 、本地快速健康检查 (check)、诊断数据上传等功能。
- Clinic Server：部署在云端的云服务。该云服务提供 SaaS 模式的诊断服务，可接收上传到该组件的的诊断数据，也可提供诊断数据的存储、在线查看、在线诊断以及诊断报告。

    Clinic Beta 版本的 Server 端功能暂不开放给外部用户使用，即当你将采集好的数据上传到 Clinic Server 并获取了数据链接后，只有经过授权的 PingCAP  技术支持人员可以访问其链接并查看数据。

本文介绍了 Clinic 的工作原理和使用场景。

## 工作原理

本章节主要介绍 Clinic 的集群侧工具 Diag 采集集群诊断数据的工作原理。

首先，Diag 需要从部署工具 TiUP (tiup-cluster) 或 TiDB Operator (tidb-operator) 获取集群拓扑信息，然后通过不同的数据采集方式来采集不同类型的诊断数据。 

### 数据采集方式 1：通过 SCP 方式传输服务器文件

对于使用 TiUP 部署的集群，Diag 可通过 SCP 方式直接从目标组件的节点采集日志文件和配置文件。

### 数据采集方式 2：通过 SSH 远程执行命令采集数据

对于 TiUP 部署的集群，Diag 可以通过 SSH (Secure Shell) 连接到目标组件系统，并可执行 Insight 等命令获取系统信息，包括内核日志、内核参数、基础的系统和硬件信息等。

###  数据采集方式3：通过 HTTP 调用采集数据

- 通过调用 TiDB 组件的 HTTP 接口，Diag 可获取 TiDB、TiKV、PD 等组件的实时配置采样信息与实时性能采样信息。
- 通过调用 Prometheus 的 HTTP 接口，Diag 可获取报警信息和 metrics 监控数据。

### 数据采集方式4：通过 SQL 语句查询数据库参数

通过 SQL 语句，Diag 可查询 TiDB 数据库的系统参数等信息。该方式需要用户在采集时**额外提供**访问 TiDB 数据库的用户名和密码。

## 使用场景

## 使用场景
Clinic 诊断服务主要应用于以下业务场景：

- 远程定位集群问题：

    当集群出现无法快速修复的问题时，可以求助社区论坛或者联系 PingCAP 技术支持。当申请远程协助时，你需要保存问题现场的各种诊断数据后，将其转发给相关技术人员。此时，你可以使用 Clinic 的 Diag 工具，对诊断数据进行一键采集，快速收集完整的诊断数据，替代复杂的手动数据采集操作。同时，你也可以把诊断数据上传到 Clinic Server，供 PingCAP 技术人员查看。Clinic Server 为诊断数据提供了安全的存储，并支持在线诊断，提升了技术人员进行问题定位的效率。

- 本地快速诊断集群问题：

    当集群能正常运行时，也需要定期检查集群是否有潜在的稳定性风险。Clinic 提供的本地快速诊断功能，能够检查潜在的健康风险。目前 Clinic Beta 版本主要提供对集群配置项的合理性检查，用于发现不合理的配置，并提供修改建议。