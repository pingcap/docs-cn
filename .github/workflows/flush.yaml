name: Flush PDF

on:
  workflow_dispatch:
    inputs:
      cloud:
        default: false
        required: false
        type: boolean
        description: "Is cloud?"
      version:
        required: false
        type: string
        description: "The version, e.g. 'v6.5' or 'dev'"
      lang:
        required: false
        type: string
        description: "The language, e.g. 'en' or 'zh'"
  schedule:
    - cron: "0 0 * * 0" # auto flush pdf on sunday

jobs:
  flush-pdf:
    name: Flush PDF
    runs-on: ubuntu-latest
    steps:
      - name: install qiniu qshell
        uses: foxundermoon/setup-qshell@v5
        with:
          version: '2.6.2'

      - name: Get pdf list (tidb)
        if: ${{ !inputs.cloud}}
        run: |
          echo "https://download.pingcap.org/tidb-${{inputs.version}}-${{inputs.lang}}-manual.pdf" > pdf.txt
          cat pdf.txt

      - name: Get pdf list (tidb cloud)
        if: ${{ inputs.cloud}}
        run: |
          echo "https://download.pingcap.org/tidbcloud-en-manual.pdf" > pdf.txt
          cat pdf.txt


      - name: refresh url
        run: |
          qshell account ${{ secrets.QINIU_ACCESS_KEY }} ${{ secrets.QINIU_SECRET_KEY }} tidb
          result=$(qshell cdnrefresh -i pdf.txt)
          if echo $result | grep -w '200'; then
            echo 'CDN refresh success'
          else
            echo "CDN refresh failed: $result"
            exit 1
          fi

