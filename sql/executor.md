---
title: TiDB 执行器原理
category: user guide
---

# TiDB 执行器原理

## 聚合操作执行原理

在 SQL 中聚合操作对一组值执行计算，并返回单个值。TiDB 实现了 2 种聚合算法：Hash 聚合（Hash Aggregate）和 Stream 聚合（Stream Aggregate）。

我们首先以 `avg` 函数的执行流程为例，简述两种算法的执行原理。

假设表 t 数据如下，执行 sql `select avg(b) from t group by a `

| 列 a | 列 b |
| ---- | ---- |
| 1    | 9    |
| 1    | -8   |
| 2    | -7   |
| 2    | 6    |
| 1    | 5    |
| 2    | 4    |

`avg` 的计算过程中，我们需要维护 2 个中间结果变量 `sum` 和 `count`。算法的详细执行过程如下：

### Hash Aggregate

在 Hash Aggregate 的计算过程中，我们需要维护一个 Hash 表，Hash 表的键为聚合计算的 Group-By 列，值为聚合函数的中间结果。在本例中，键为 `列 b` 的值，值为 `sum(a)` 和 `count(a)`。

计算过程中，只需要根据每行输入数据计算出键，在 Hash 表中找到对应值进行更新即可。对本例的执行过程模拟如下。

| 输入数据 | Hash 表 [key] (sum, count) |
| -------- | -------------------------- |
| 1  9     | [1] (9, 1)                 |
| 1  -8    | [1] (1, 2)                 |
| 2  -7    | [1] (1, 2)     [2] (-7, 1) |
| 2  6     | [1] (1, 2)     [2] (-1, 2) |
| 1  5     | [1] (6, 3)     [2] (-1, 2) |
| 2  4     | [1] (2, 3)     [2] (3, 3)  |

输入数据输入完后，扫描 Hash 表并计算，便可以得到最终结果：

| Hash 表    | avg(b) |
| ---------- | ------ |
| [1] (2, 3) | 2      |
| [2] (1, 3) | 1      |

TiDB 中，为了加快执行速度，Hash Aggregate 在聚合函数参数不为 distinct 时并行执行。

### Stream Aggregate

Stream Aggregate 的计算需要保证输入数据**按照 Group-By 列有序**。在计算过程中，每当读到一个新的 Group 的值或数据输入完成时，便对前一个 Group 的聚合结果进行计算。

对于本例，我们首先需要对输入数据进行排序。排序后，本例执行过程模拟如下。

| 输入数据 | 是否为新 Group或数据输入完成 | avg(b)                        |
| -------- | ---------------------------- | ----------------------------- |
| 1  9     | 是                           | 前一个 Group 为空，不进行计算 |
| 1  -8    | 否                           |                               |
| 1  5     | 否                           |                               |
| 2  -7    | 是                           | 2                             |
| 2  6     | 否                           |                               |
| 2  4     | 否                           |                               |
|          | 是                           | 1                             |

当 Group-By 列上存在索引时，由索引读入数据可以保证数据输入有序，此时可以避免额外的排序操作；此外，Stream Aggreate 不需要读取所有的数据才开始计算，因此当只需要计算部分结果时，可以提前中断后续的计算。
