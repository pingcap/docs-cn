# SQL DIAGNOSIS

SQL 诊断功能是由 TiDB 4.0 引入的新特性，主要用于提升 TiDB 问题定位效率，相较于 4.0 版本之前，不同的信息需要使用不同工具获取的异构方式，
新的 SQL 诊断对这些离散的信息进行了整体设计，它通过将系统的各种维度信息通过系统表的方式向上层提供了一致的接口方式以及监控汇总与自动诊断，方便了用户对于集群信息的查询。

SQL 诊断共分三大块：

* **集群信息表**：TiDB 4.0 诊断功能为原先离散的各节点实例信息提供了一致的获取方式，它将整个集群的集群拓扑、硬件信息、软件信息、内核参数、监控、系统信息、慢查询、Statements、日志完全打通，让使用者能够统一使用 SQL 查询。
* **集群监控表**：TiDB 4.0 诊断系统添加了集群监控系统表，所有表都在 metrics_schema 中，可以通过 SQL 的方式查询监控，相对于原先的可视化监控，SQL 查询监控的好处在于可以对整个集群的所有监控进行关联查询，并对比不同时间段的结果，迅速找出性能瓶颈。
且由于 TiDB 集群的监控指标数量较大，SQL 诊断还提供了监控汇总表，从而让用户能以一种更加便捷的方式从众多监控中找出异常的监控项。
* **自动诊断**：尽管用户可以手动执行 SQL 来查询集群信息表和集群监控表与汇总表来发现集群问题，但自动挡总是更香的，所以 SQL 诊断利用已有的基础信息表提供了诊断相关的系统表来自动执行诊断。

## 集群信息表

集群信息表包括集群拓扑、集群配置、集群硬件、内核参数、系统负载、日志、集群监控等，这些集群表将一个集群中的所有节点实例的信息都汇聚到了一起，让用户仅通过一条 SQL 就能查询整个集群相关信息。
新增的集群信息表如下：

* 集群拓扑表 `information_schema.cluster_info` 主要是用于获取集群当前的拓扑信息，以及各个节点的版本、版本对应的 Git Hash、启动时间、运行时间信息。
* 集群配置表 `information_schema.cluster_config` 用于获取集群当前所有节点的配置，TiDB 4.0 之前的版本必须逐个访问各个节点的 HTTP API。
* 集群硬件表 `information_schema.cluster_hardware` 主要用于快速查询集群硬件信息。
* 集群负载表 `information_schema.cluster_load` 主要用于查询集群不同节点的不同硬件类型的负载信息。
* 内核参数表 `information_schema.cluster_systeminfo` 主要用于查询集群不同节点的内核配置信息，目前支持查询 sysctl 的信息。
* 集群日志表 `information_schema.cluster_log` 表主要用于集群日志查询，通过将查询条件下推到各个节点，降低日志查询对集群的影响，性能影响小于等 grep 命令。

TiDB 4.0 之前的以下系统表，只能查看当前节点，TiDB 4.0 实现了对应的集群表，可以在单个 TiDB 节点上拥有整个集群的全局视图。
这些表目前都位于 information_schema 中，查询形式上与其他 information_schema 系统表一致。

## 集群监控表

为了能够动态地观察并对比不同时间段的集群情况，TiDB 4.0 诊断系统添加了集群监控系统表，所有表都在 `metrics_schema` 中，可以通过 SQL 的方式查询监控，SQL 查询监控的好处在于可以对整个集群的所有监控进行关联查询，并对比不同时间段的结果，迅速找出性能瓶颈。

* `information_schema.metrics_tables`：由于目前添加的系统表数量较多，因此用户可以通过该表查询这些监控表的相关元信息。

由于 TiDB 集群的监控指标数量较大，因此 TiDB 4.0 提供了监控汇总表：

* 监控汇总表 `information_schema.metrics_summary` 用于汇总所有监控数据，以提升用户对各个监控指标进行排查的效率。
* 监控汇总表 `information_schema.metrics_summary_by_label` 同样用于汇总所有监控数据，不过它会对不同的 label 使用区分统计。

## 自动诊断

前面介绍了集群信息表和集群监控表，并通过 SQL 演示了如何通过查询这些表来发现集群问题，比如通过 information_schema.cluster_config 发现集群不同节点配置不一致，通过 `information_schema.metrics_summary` 发现指定时间范围内 TiDB 集群中平均耗时最高的监控项。
不过手动执行固定模式的 SQL 排查集群问题是低效的，为了进一步优化用户体验，方便用户使用，于是我们利用已有的基础信息表提供了诊断相关的系统表来自动执行诊断：

* 诊断结果表 `information_schema.inspection_result` 用于展示对系统的诊断结果，诊断是惰性触发，使用 SQL `select * from inspection_result` 会触发所有的诊断规则对系统进行诊断，并会在结果集中展示系统中的故障或风险。
* 诊断汇总表 `information_schema.inspection_summary` 用于对特定链路或模块的监控进行汇总，用户可以根据整个模块或链路的上下文来排查定位问题。