---
title: 避免隐式类型转换
summary: 介绍 TiDB 中隐式类型转换可能带来的后果以及避免方法。
---

# 避免隐式类型转换

本文档介绍 TiDB 中隐式类型转换的规则和可能带来的后果，以及如何避免隐式类型转换。

## 转换规则

当 SQL 语句中谓词两侧的数据类型不匹配时，TiDB 会隐式地将一侧或双侧的数据类型转换为兼容的数据类型以进行谓词运算。

TiDB 中隐式类型转换的规则如下：

- 如果一个或两个参数为 `NULL`，比较的结果为 `NULL`。NULL 安全的 `<=>` 等价比较运算符不需要转换，因为 NULL `<=>` NULL 的结果为 `true`。
- 如果比较操作中的两个参数都是字符串，则按字符串进行比较。
- 如果两个参数都是整数，则按整数进行比较。
- 如果没有与数字进行比较，则十六进制值被视为二进制字符串。
- 如果其中一个参数是小数值，比较取决于另一个参数。如果另一个参数是小数值或整数值，则与小数值进行比较。如果另一个参数是浮点值，则与浮点值进行比较。
- 如果其中一个参数是 `TIMESTAMP` 或 `DATETIME` 列，另一个参数是常量，则在执行比较之前将常量转换为时间戳。
- 在所有其他情况下，参数都作为浮点数（`DOUBLE` 类型）进行比较。

## 隐式类型转换带来的后果

隐式类型转换增加了人机交互的可用性。但是，应避免在应用程序代码中使用隐式类型转换，因为它们可能会导致以下问题：

- 索引失效
- 精度损失

### 索引失效

在以下情况中，`account_id` 是主键，其数据类型为 `varchar`。在执行计划中，这条 SQL 语句存在隐式类型转换，无法使用索引。

```sql
DESC SELECT * FROM `account` WHERE `account_id`=6010000000009801;
+-------------------------+----------------+-----------+---------------+------------------------------------------------------------+
| id                      | estRows        | task      | access object | operator info                                              |
+-------------------------+----------------+-----------+---------------+------------------------------------------------------------+
| TableReader_7           | 8000628000.00  | root      |               | data:Selection_6                                           |
| └─Selection_6           | 8000628000.00  | cop[tikv] |               | eq(cast(findpt.account.account_id), 6.010000000009801e+15) |
|   └─TableFullScan_5     | 10000785000.00 | cop[tikv] | table:account | keep order:false                                           |
+-------------------------+----------------+-----------+---------------+------------------------------------------------------------+
3 rows in set (0.00 sec)
```

**运行结果简述**：从上述执行计划中，可以看到 `Cast` 运算符。

### 精度损失

在以下情况中，`a` 字段的数据类型为 `decimal(32,0)`。在执行计划中，发生了隐式类型转换，小数字段和字符串常量都被转换为 double 类型。由于 double 类型的精度不如 decimal，会出现精度损失。在这种情况下，SQL 语句错误地过滤了超出范围的结果集。

```sql
DESC SELECT * FROM `t1` WHERE `a` BETWEEN '12123123' AND '1111222211111111200000';
+-------------------------+---------+-----------+---------------+-------------------------------------------------------------------------------------+
| id                      | estRows | task      | access object | operator info                                                                       |
+-------------------------+---------+-----------+---------------+-------------------------------------------------------------------------------------+
| TableReader_7           | 0.80    | root      |               | data:Selection_6                                                                    |
| └─Selection_6           | 0.80    | cop[tikv] |               | ge(cast(findpt.t1.a), 1.2123123e+07), le(cast(findpt.t1.a), 1.1112222111111112e+21) |
|   └─TableFullScan_5     | 1.00    | cop[tikv] | table:t1      | keep order:false, stats:pseudo                                                      |
+-------------------------+---------+-----------+---------------+-------------------------------------------------------------------------------------+
3 rows in set (0.00 sec)
```

**运行结果简述**：从上述执行计划中，可以看到 `Cast` 运算符。

```sql
SELECT * FROM `t1` WHERE `a` BETWEEN '12123123' AND '1111222211111111200000';
+------------------------+
| a                      |
+------------------------+
| 1111222211111111222211 |
+------------------------+
1 row in set (0.01 sec)

```

**运行结果简述**：上述执行给出了错误的结果。

## 需要帮助？

<CustomContent platform="tidb">

在 [Discord](https://discord.gg/DQZ2dy3cuc?utm_source=doc) 或 [Slack](https://slack.tidb.io/invite?team=tidb-community&channel=everyone&ref=pingcap-docs) 上询问社区，或[提交支持工单](/support.md)。

</CustomContent>

<CustomContent platform="tidb-cloud">

在 [Discord](https://discord.gg/DQZ2dy3cuc?utm_source=doc) 或 [Slack](https://slack.tidb.io/invite?team=tidb-community&channel=everyone&ref=pingcap-docs) 上询问社区，或[提交支持工单](https://tidb.support.pingcap.com/)。

</CustomContent>
