---
title: 代价模型
aliases: ['/docs-cn/dev/cost-model/']
---

# 代价模型

如下图，TiDB 在物理优化时会使用代价模型来进行索引选择和算子选择：

![CostModel](/media/cost-model.png)

TiDB 会计算每个索引的访问代价和计划中每个物理算子的执行代价（如 HashJoin、IndexJoin 等），选择代价最低的计划。

下面是一个简化的例子，用来解释代价模型的原理，比如有这样一张表：

```sql
mysql> SHOW CREATE TABLE t;
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                        |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `a` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  `c` int(11) DEFAULT NULL,
  KEY `b` (`b`),
  KEY `c` (`c`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```

在处理查询 `SELECT * FROM t WHERE b<100 and c<100` 时，假设 TiDB 对 `b<100` 和 `c<100` 的行数估计分别为 20 和 500，`INT` 类型索引行宽为 8，则 TiDB 会分别计算两个索引的代价：

+ 索引 `b` 的扫描代价 = `b<100 行数` * `索引 b 行宽` = 20 * 8 = 160
+ 索引 `c` 的扫描代价 = `c<100 行数` * `索引 c 行宽` = 500 * 8 = 4000

由于扫描 `b` 的代价更低，因此 TiDB 会选择 `b` 索引。

上述是一个简化后的例子，只是用于做原理解释，实际 TiDB 的代价模型会更加复杂，具体的代价公式可以见[源码](https://github.com/pingcap/tidb/blob/master/planner/core/plan_cost.go)。

## Cost Model Version 2

> **警告：**
>
> - Cost Model Version 2 目前为实验特性，不建议在生产环境中使用。
>
> - 切换代价模型版本可能引起计划的变动。

在 v6.2 版本中，我们引入了新的代价模型 Cost Model Version 2，在内部测试中，它比旧版代价模型更加准确。

如下图，右边新版的代价模型估算出来的代价和计划实际的执行时间更加吻合：

![cost-model-ver2](/media/cost-model-ver2.png)

你可以通过设置变量 `tidb_cost_model_version` 来控制代价模型的版本。